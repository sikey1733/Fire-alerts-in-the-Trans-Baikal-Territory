name: üî• Fire Risk Daily Pipeline

on:
  schedule:
    - cron: "0 11 * * *"   # –∑–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 11:00 UTC
  workflow_dispatch:       # –∑–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é

jobs:
  run-r-script:
    runs-on: ubuntu-latest

    env:
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      VIIRS_KEY: ${{ secrets.VIIRS_KEY }}
      CDS_API_KEY: ${{ secrets.CDS_API_KEY }}
      CDS_USER_ID: ${{ secrets.CDS_USER_ID }}
      R_LIBS_USER: ${{ github.workspace }}/r-library

    steps:
      - name: üîΩ Checkout repository
        uses: actions/checkout@v4

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ R
        uses: r-lib/actions/setup-r@v2

      - name: üì¶ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤ R
        uses: actions/cache@v3
        with:
          path: ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-r-packages-${{ hashFiles('**/*.R', '**/*.Rmd') }}
          restore-keys: |
            ${{ runner.os }}-r-packages-

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π R
        run: |
          Rscript -e 'install.packages(c("ecmwfr", "tidyverse", "stars", "openair", "httr", "lubridate", "osmdata", "sf", "leaflet", "geosphere", "mapview", "htmlwidgets", "webshot", "ggplot2", "rmarkdown", "curl", "xml2"), repos="https://cloud.r-project.org/", lib=Sys.getenv("R_LIBS_USER"))'
          Rscript -e 'webshot::install_phantomjs()'

      - name: –ó–∞–ø—É—Å–∫ R-—Å–∫—Ä–∏–ø—Ç–∞
        run: |
          Rscript -e 'source("pipeline.R"); main()'

      - name: üìÇ –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ output/ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
        run: ls -l output/

      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ output
        uses: actions/upload-artifact@v4
        with:
          name: output-plots
          path: output/
          if-no-files-found: warn
