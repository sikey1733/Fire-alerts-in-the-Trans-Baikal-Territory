name: üî• Fire Risk Daily Pipeline

on:
  schedule:
    - cron: "0 11 * * *"  # –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 14:00 –ø–æ –ú–°–ö
  workflow_dispatch:

jobs:
  run-r-script:
    runs-on: ubuntu-latest

    env:
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      VIIRS_KEY: ${{ secrets.VIIRS_KEY }}
      CDS_API_KEY: ${{ secrets.CDS_API_KEY }}
      CDS_USER_ID: ${{ secrets.CDS_USER_ID }}
      R_LIBS_USER: ~/R/Library

    steps:
      - name: üîΩ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ R
        uses: r-lib/actions/setup-r@v2

      - name: üì¶ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫ R
        uses: actions/cache@v3
        with:
          path: ~/R/Library
          key: ${{ runner.os }}-r-${{ hashFiles('**/*.R', '**/*.Rmd', '**/DESCRIPTION') }}
          restore-keys: |
            ${{ runner.os }}-r-

      - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
        run: |
          sudo apt-get update
          sudo apt-get install -y \
          libcurl4-openssl-dev libssl-dev libxml2-dev \
          libudunits2-dev libgdal-dev libgeos-dev libproj-dev \
          libfontconfig1-dev \
          libharfbuzz-dev libfreetype6-dev \
          libfribidi-dev

      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ –∑–∞–ø—É—Å–∫
        run: |
          mkdir -p ~/R/Library
          export R_LIBS_USER=~/R/Library

          echo "üëâ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
          Rscript -e 'install.packages(c("curl", "httr"), repos = "https://cloud.r-project.org")'

          echo "üëâ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é ecmwfr"
          Rscript -e 'install.packages("ecmwfr", repos = "https://cloud.r-project.org")'
          Rscript -e 'library(ecmwfr); print("‚úÖ ecmwfr –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ!")'

          echo "üëâ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
          Rscript -e 'install.packages(c(
            "tidyverse", "stars", "openair", "lubridate", 
            "osmdata", "sf", "leaflet", "geosphere", "mapview", "htmlwidgets", 
            "webshot", "ggplot2", "rmarkdown", "xml2"
          ), repos = "https://cloud.r-project.org")'

          echo "üëâ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é PhantomJS"
          Rscript -e 'webshot::install_phantomjs()'

          echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏"
          Rscript Scripts/pipeline.R

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
        run: |
          export R_LIBS_USER=~/R/Library
          Rscript -e 'print(installed.packages()[, "Package"])'

      - name: üìÇ –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–∞–ø–∫–∏ output/
        run: ls -lh output/ || echo "–ù–µ—Ç –ø–∞–ø–∫–∏ output/"

      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ (output/)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: output-plots
          path: output/
          if-no-files-found: warn
